<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>stubbing constants in ruby tests - hardscrabble</title>
  <meta content='Max Jacobson' name='author'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='/feed.xml' rel='alternate' title='Posts feed' type='application/atom+xml'>
  <link href='/img/favicon.ico' rel='icon' type='image/x-icon'>
  <link rel="stylesheet" href="/css/lib/pinboard.css">
<link rel="stylesheet" href="/css/lib/normalize.css">
<link rel="stylesheet" href="/css/lib/solarized.css">
<link rel="stylesheet" href="/css/style.css">



  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-4982721-15", 'auto');
  ga('send', 'pageview');

</script>


</head>
<body>

<header>
  <h1><a href="/">hardscrabble</a></h1>
  <nav>
    <a href="/">home</a>
    | <a href="/about/">about</a>
    | <a href="/metaphorloop/">metaphor loop</a>
    | <a href="/search/">search</a>
    | <a href="/links/">links</a>
  </nav>
</header>

<div class="post">

  <div class="metadata">
    <div class="title">
      <h2>
        stubbing constants in ruby tests
      </h2>
    </div>
    <div class="byline">
      by <a href='/about'>Max Jacobson</a>
    </div>
    <div class="date">
      20 Jul 2015
    </div>
  </div>

  <div class="body">
    <p>Let’s say you have some code that doesn’t have tests and you want to add tests.
Because the code wasn’t written with tests in mind, it might be hard to write
tests for it.</p>

<p>Last year, DHH wrote a blog post called <a href="http://david.heinemeierhansson.com/2014/test-induced-design-damage.html">Test-induced design damage</a> which
argued that code “written with tests in mind” (quoting myself from the previous
paragraph, not his post) isn’t necessarily better than code written with other
goals in mind, and can often be worse.</p>

<p>When I’ve attempted TDD, I’ve had times when I felt like it helped me write nice
code and times where I think I went too far like if you’re rolling out some
dough to make a pie crust but you’re watching TV and you end up spreading it out
until it covers the whole counter.</p>

<p>So this code you want to test. What makes it hard to test? Let’s say it’s a Ruby
class in a Rails app. In Rails apps, all the classes are available for all the
other classes to reference and depend on. Maybe it looks like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PieCrust</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">pounds_of_dough</span><span class="p">)</span>
    <span class="vi">@lbs</span> <span class="o">=</span> <span class="n">pounds_of_dough</span>
    <span class="vi">@ready</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">prep</span>
    <span class="no">RollingPin</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">roll_out</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="no">Oven</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">preheat</span>
    <span class="no">Instagram</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="vi">@ready</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">ready?</span>
    <span class="vi">@ready</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>(This example is revealing more about my state of mind right now than anything)</p>

<p>But like, look at this thing. How do we write a test that covers all that? And
what if we want “fast tests”?</p>

<p>(Note: a lot of people really want their tests to run fast. For TDD enthusiasts,
this allows a tight feedback loop between when you write the failing test to
when you write the code which makes the test pass. They kind of expect to do
that over and over and over and don’t want to wait for more than an instant. I
don’t think they’re wrong to want that although I am personally often OK with
waiting for longer than an instant.)</p>

<p>(Other people want their tests to run fast as a general principle, like they
want their cars to go fast or their legs to.)</p>

<p>Let’s say there are a couple hundred classes in your app and a bunch of
initializers which run whenever your Rails application is loaded and none of
them are strictly necessary for you to feel confident that your <code class="highlighter-rouge">PieCrust</code> class
is behaving properly. All you want to know is that calling the <code class="highlighter-rouge">prep</code> method
rolls out the crust, preheats the oven, and uploads the pie crust to instagram.</p>

<p>You already know that all those things work as long as you call them properly
because you have unit tests for those classes demonstrating how to call them
properly. You can see that here they’re being called properly, so you don’t feel
the need to <em>actually</em> load the rolling pin code, or the oven code, or the
instagram code. And you <em>really</em> don’t want to upload something to instagram
every time you run your tests.</p>

<p>What do you do?</p>

<p>There’s the dependency injection approach, where you might refactor the earlier
code to look like:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PieCrust</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">pounds_of_dough</span><span class="p">,</span> <span class="ss">roller: </span><span class="no">RollingPin</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">heater: </span><span class="no">Oven</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">photo_sharing_service: </span><span class="no">Instagram</span><span class="p">)</span>
    <span class="vi">@lbs</span> <span class="o">=</span> <span class="n">pounds_of_dough</span>
    <span class="vi">@roller</span> <span class="o">=</span> <span class="n">roller</span>
    <span class="vi">@heater</span> <span class="o">=</span> <span class="n">heater</span>
    <span class="vi">@photo_sharing_service</span> <span class="o">=</span> <span class="n">photo_sharing_service</span>
    <span class="vi">@ready</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">prep</span>
    <span class="n">roller</span><span class="p">.</span><span class="nf">roll_out</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="n">heater</span><span class="p">.</span><span class="nf">preheat</span>
    <span class="n">photo_sharing_service</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="vi">@ready</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">ready?</span>
    <span class="vi">@ready</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_reader</span> <span class="ss">:roller</span><span class="p">,</span> <span class="ss">:heater</span><span class="p">,</span> <span class="ss">:photo_sharing_service</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Which lets you leave your other application code the same – it can interact
with PieCrust the same as it did before, as the default values are totally
sensible there. But you can now write a test like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">PieCrust</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#prep, #ready'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'rolls the crust, preheats the oven, and uploads the photo'</span> <span class="k">do</span>
      <span class="n">roller</span> <span class="o">=</span> <span class="n">double</span>
      <span class="n">heater</span> <span class="o">=</span> <span class="n">double</span>
      <span class="n">photo_sharing_service</span> <span class="o">=</span> <span class="n">double</span>

      <span class="n">pie_crust</span> <span class="o">=</span> <span class="no">PieCrust</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="ss">roller: </span><span class="n">roller</span><span class="p">,</span> <span class="ss">heater: </span><span class="n">heater</span><span class="p">,</span> <span class="ss">photo_sharing_service: </span><span class="n">photo_sharing_service</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">be_ready</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">roller</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:roll_out</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">heater</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:preheat</span><span class="p">).</span><span class="nf">with_no_arguments</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">photo_sharing_service</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:upload</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">)</span>

      <span class="n">pie_crust</span><span class="p">.</span><span class="nf">prep</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_ready</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I feel like this is OK but it feels like it prescribes and duplicates a lot of
the stuff that’s going on in the application code, which doesn’t feel ideal to
me but also feels kind of fine.</p>

<p>Is there any other way? There is. I learned this one from my brilliant coworker
<a href="http://github.com/elmassimo/">Máximo Mussini</a>. While looking through a gem he
made (<a href="https://github.com/ElMassimo/journeyman">Journeyman</a>, a lightweight replacement to FactoryGirl), I discovered
some super interesting code, and without his blessing I extracted it out into
a gem which I may use to help me write tests in the future. That gem is called
<a href="https://github.com/maxjacobson/stub_constant">stub_constant</a>, and using it, I would revert that code to the first version,
avoiding the arguably awkward dependency injection.</p>

<p>You might be assuming: OK, so if you don’t inject the constants, you must load
the entire application environment, because you’re going to be depending on
those dependencies. Or like, maybe you don’t load the entire application
environment, but you must at least load the code which defines those 3
constants, right?</p>

<p>Nope! Doing that is usually really difficult, because once you load the files
which define those constants, those files are probably referencing other
constants, so you need to load the files which define <em>those</em> constants and now
you might as well just load the whole thing…</p>

<p>So… “Whaaaat?” You might say.</p>

<p>Here’s what the constant-referencing isolation tests would look like:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"stub_constant"</span>
<span class="no">StubConstant</span><span class="p">.</span><span class="nf">klass</span><span class="p">(</span><span class="ss">:Oven</span><span class="p">)</span>
<span class="no">StubConstant</span><span class="p">.</span><span class="nf">klass</span><span class="p">(</span><span class="ss">:RollingPin</span><span class="p">)</span>
<span class="no">StubConstant</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="ss">:Instagram</span><span class="p">)</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">PieCrust</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#prep, #ready?'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'rolls the crust, preheats the oven, and uploads the photo'</span> <span class="k">do</span>
      <span class="n">roller</span> <span class="o">=</span> <span class="n">double</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">RollingPin</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">).</span><span class="nf">with_no_arguments</span><span class="p">.</span><span class="nf">and_return</span><span class="p">(</span><span class="n">roller</span><span class="p">)</span>

      <span class="n">heater</span> <span class="o">=</span> <span class="n">double</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Oven</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">).</span><span class="nf">with_no_arguments</span><span class="p">.</span><span class="nf">and_return</span><span class="p">(</span><span class="n">heater</span><span class="p">)</span>

      <span class="n">pie_crust</span> <span class="o">=</span> <span class="no">PieCrust</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">be_ready</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">roller</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:roll_out</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">heater</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:preheat</span><span class="p">).</span><span class="nf">with_no_arguments</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Instagram</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:upload</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">)</span>

      <span class="n">pie_crust</span><span class="p">.</span><span class="nf">prep</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">pie_crust</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_ready</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Sooo it got even more prescriptive. But it’s a pretty neat way to do a purely
isolated test without needing to rewrite your code.</p>

<p>How would you test this? I want to know.</p>

  </div>

  <div class="post-footer">
    <p>
      Feel free to get in touch via <a href='http://twitter.com/maxjacobson'>@maxjacobson</a> or <a href='mailto:max@hardscrabble.net'>max@hardscrabble.net</a>
    </p>
  </div>

</div>


<footer>
  <div>
    Powered by <a href="http://jekyllrb.com/">Jekyll</a>
    and hosted on <a href="https://pages.github.com/">GitHub Pages</a>.
    The source is <a href="https://github.com/hardscrabble/hardscrabble.github.io">available to browse, for nerds</a>.
    The feed can be found at <a href="/feed.xml">feed.xml</a>
  </div>
</footer>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src='/js/vendor/lunr.min.js'></script>
<script src='/js/app.js'></script>


<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100815498); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100815498ns.gif" /></p></noscript>
</body>
</html>


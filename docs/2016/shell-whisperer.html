<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>how to run shell commands from ruby if you care about their output or if they failed - hardscrabble</title>
  <meta content='Max Jacobson' name='author'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='/feed.xml' rel='alternate' title='Posts feed' type='application/atom+xml'>
  <link href='/img/favicon.ico' rel='icon' type='image/x-icon'>
  <link rel="stylesheet" href="/css/lib/pinboard.css">
<link rel="stylesheet" href="/css/lib/normalize.css">
<link rel="stylesheet" href="/css/lib/solarized.css">
<link rel="stylesheet" href="/css/style.css">



  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-4982721-15", 'auto');
  ga('send', 'pageview');

</script>


</head>
<body>

<header>
  <h1><a href="/">hardscrabble</a></h1>
  <nav>
    <a href="/">home</a>
    | <a href="/about/">about</a>
    | <a href="/metaphorloop/">metaphor loop</a>
    | <a href="/search/">search</a>
    | <a href="/links/">links</a>
  </nav>
</header>

<div class="post">

  <div class="metadata">
    <div class="title">
      <h2>
        how to run shell commands from ruby if you care about their output or if they failed
      </h2>
    </div>
    <div class="byline">
      by <a href='/about'>Max Jacobson</a>
    </div>
    <div class="date">
      31 Jan 2016
    </div>
  </div>

  <div class="body">
    <p>Recently I made a new gem called <a href="https://rubygems.org/gems/shell_whisperer">shell whisperer</a> which you might find
useful for when your ruby programs need to run shell commands.</p>

<p>Let’s say you want to write a script which prints a summary of the current
directory. The desired output is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>There are 213 files in this git repo.
Last commit: fixed a typo
</code></pre>
</div>

<p>There are two questions we need to ask the shell in order to print this output.</p>

<p>First question: how many files are there in this git repo?</p>

<p>First answer: we can ask git to list the files in the repo, and pipe the list to
the word counting command to get the answer:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git ls-files | wc -l
</code></pre>
</div>

<p>Second question: what is the last commit?</p>

<p>Second answer: we can ask git for the log, limited to the most recent commit,
and formatted to include just the first line:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git log -1 --pretty<span class="o">=</span><span class="s2">"%s"</span>
</code></pre>
</div>

<p>So far so good, but how do we run these commands from Ruby?</p>

<p>The language provides two ways that I’m aware of:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># backtick style</span>
<span class="sb">`git ls-files | wc -l`</span>
</code></pre>
</div>

<p>Or:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># system style</span>
<span class="nb">system</span> <span class="s1">'git ls-files | wc -l'</span>
</code></pre>
</div>

<p>What is the difference? I don’t want to go into all of the nuances (see
<a href="http://stackoverflow.com/a/18623297">this SO post for that and more</a>) but I’ll share how I think of the
difference:</p>

<ol>
  <li>if you use the backtick (`) style, the return value is whatever was output by
the command – but only STDOUT, not STDERR, so you’ll miss error messages</li>
  <li>if you use the system style, the output from the command will go to STDOUT,
as if you had run <code class="highlighter-rouge">puts</code> and output some text, and the return value will
signify whether the command failed or not</li>
</ol>

<p>So our program might look something like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">count</span> <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">count</span>
<span class="n">message</span> <span class="o">=</span> <span class="sb">`git log -1 --pretty="%s"`</span><span class="p">.</span><span class="nf">chomp</span>
<span class="nb">puts</span> <span class="s2">"There are </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files in this git repo."</span>
<span class="nb">puts</span> <span class="s2">"Last commit: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span>
</code></pre>
</div>

<p>And this is <em>okay</em>.</p>

<p>The issue becomes: well, what do you if you care that the command might fail?
The system style allowed for checking the return value to see whether it
succeeded or failed, but there’s a reason we’re not using the system style: we
care about capturing the output of the command. So with the backtick style, we
can capture the output, but (seemingly) we can’t capture the successfulness.</p>

<p>Well, we can, it’s just a little awkward:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">count</span> <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">count</span>
<span class="k">raise</span> <span class="s1">'list failed somehow'</span> <span class="k">unless</span> <span class="vg">$?</span><span class="p">.</span><span class="nf">success?</span>
<span class="n">message</span> <span class="o">=</span> <span class="sb">`git log -1 --pretty="%s"`</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">raise</span> <span class="s1">'message failed somehow'</span> <span class="k">unless</span> <span class="vg">$?</span><span class="p">.</span><span class="nf">success?</span>
<span class="nb">puts</span> <span class="s2">"There are </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files in this git repo."</span>
<span class="nb">puts</span> <span class="s2">"Last commit: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span>
</code></pre>
</div>

<p>Which, OK, kind of cool, but what if we want to know <em>why</em> it failed?</p>

<p>This is possible:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">count_or_failure_reason</span> <span class="o">=</span> <span class="sb">`git ls-files 2&gt;&amp;1`</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">count</span>
<span class="k">raise</span> <span class="n">count_or_failure_reason</span> <span class="k">unless</span> <span class="vg">$?</span><span class="p">.</span><span class="nf">success?</span>
<span class="n">message_or_failure_reason</span> <span class="o">=</span> <span class="sb">`git log -1 --pretty="%s" 2&gt;&amp;1`</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">raise</span> <span class="n">message_or_failure_reason</span> <span class="k">unless</span> <span class="vg">$?</span><span class="p">.</span><span class="nf">success?</span>
<span class="nb">puts</span> <span class="s2">"There are </span><span class="si">#{</span><span class="n">count_or_failure_reason</span><span class="si">}</span><span class="s2"> files in this git repo."</span>
<span class="nb">puts</span> <span class="s2">"Last commit: </span><span class="si">#{</span><span class="n">message_or_failure_reason</span><span class="si">}</span><span class="s2">"</span>
</code></pre>
</div>

<p>Let me attempt to explain this. The <code class="highlighter-rouge">2&gt;&amp;1</code> part means that we want the STDERR
stream to be directed to the STDOUT stream, so that we’ll capture either one
(or both). This gives us access to the reason the command failed, if it failed,
but still gives us access to the output if it succeeds.</p>

<p>I found myself doing this in multiple places, so I decided to wrap this pattern
up in a tiny gem, which allows you to instead write your program like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'shell_whisperer'</span>
<span class="n">count</span> <span class="o">=</span> <span class="no">ShellWhisperer</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'git ls-files'</span><span class="p">).</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">count</span>
<span class="n">message</span> <span class="o">=</span> <span class="no">ShellWhisperer</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'git log -1 --pretty="%s"'</span><span class="p">).</span><span class="nf">chomp</span>
<span class="nb">puts</span> <span class="s2">"There are </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files in this git repo."</span>
<span class="nb">puts</span> <span class="s2">"Last commit: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span>
</code></pre>
</div>

<p>If any of the commands fail, that error message will be re-raised as a
<code class="highlighter-rouge">ShellWhisperer::CommandFailed</code> exception, so you can handle that as you please.</p>

<p>The node.js community seems to be all about tiny modules, and I think that idea
is very cool, and I’m hoping to find more opportunities to do that with Ruby.</p>

  </div>

  <div class="post-footer">
    <p>
      Feel free to get in touch via <a href='http://twitter.com/maxjacobson'>@maxjacobson</a> or <a href='mailto:max@hardscrabble.net'>max@hardscrabble.net</a>
    </p>
  </div>

</div>


<footer>
  <div>
    Powered by <a href="http://jekyllrb.com/">Jekyll</a>
    and hosted on <a href="https://pages.github.com/">GitHub Pages</a>.
    The source is <a href="https://github.com/hardscrabble/hardscrabble.github.io">available to browse, for nerds</a>.
    The feed can be found at <a href="/feed.xml">feed.xml</a>
  </div>
</footer>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src='/js/vendor/lunr.min.js'></script>
<script src='/js/app.js'></script>


<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100815498); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100815498ns.gif" /></p></noscript>
</body>
</html>


<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>refactoring very old code - hardscrabble</title>
  <meta content='Max Jacobson' name='author'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='/feed.xml' rel='alternate' title='Posts feed' type='application/atom+xml'>
  <link href='/img/favicon.ico' rel='icon' type='image/x-icon'>
  <link rel="stylesheet" href="/css/lib/pinboard.css">
<link rel="stylesheet" href="/css/lib/normalize.css">
<link rel="stylesheet" href="/css/lib/solarized.css">
<link rel="stylesheet" href="/css/style.css">



  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-4982721-15", 'auto');
  ga('send', 'pageview');

</script>


</head>
<body>

<header>
  <h1><a href="/">hardscrabble</a></h1>
  <nav>
    <a href="/">home</a>
    | <a href="/about/">about</a>
    | <a href="/metaphorloop/">metaphor loop</a>
    | <a href="/search/">search</a>
    | <a href="/links/">links</a>
  </nav>
</header>

<div class="post">

  <div class="metadata">
    <div class="title">
      <h2>
        refactoring very old code
      </h2>
    </div>
    <div class="byline">
      by <a href='/about'>Max Jacobson</a>
    </div>
    <div class="date">
      13 Apr 2014
    </div>
  </div>

  <div class="body">
    <p>Before I went to Flatiron School last summer I cobbled together a web app called <a href="http://layabout.tv">Layabout</a>. This weekend, for the first time in a very long time, I worked up the nerve to look at the source code. You may have heard the phrase <a href="http://blog.codinghorror.com/code-smells/">“code smell”</a> but I’m not sure it applies to this code. This code is like that ominous stink you’d almost rather ignore?</p>

<p>Hmm.</p>

<p>Layabout is an Instapaper client that focuses on the videos you’ve bookmarked. I was the only one who ever used it. I stopped using it in part beause it was buggy, and in part because I wanted to try out Pocket for a little while, which ended up being most of a year.</p>

<p>Inspired by John Resig’s recent blog post <a href="http://ejohn.org/blog/write-code-every-day/">“Write Code Every Day”</a> encouraging employed programmers to maintain side projects in a sustainable, I decided to revisit Layabout and see if anything I’ve learned in the year since I last edited it would come in handy. I also enjoy laughing at myself from the past.</p>

<p>The app had been running on Heroku unused for a year. When I logged in<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> and tried to watch a video, it immediately crashed. I found the codebase locally and ran <code class="highlighter-rouge">heroku logs</code> to try to get some more information about the crash but it simply said it was a 500 error. Hmm.</p>

<p>So I tried running the app locally<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> and was surprised to find that it <em>worked even worse than it did on Heroku!</em> Online at least I could type my password in before it crashed, but locally no pages were rendering at all. Instead it was complaining about not being able to find the views. I googled the error message and learned that <a href="http://stackoverflow.com/a/3836158/1154301">some versions of Sinatra require you to explicitly tell it where your views are</a>. I had never had this error before, but I was having it now. I looked at my Gemfile and saw that in my list of dependencies, I didn’t specify my desired version number for any of them. Code smell! You gotta lock that down, because things can change and break, especially when you don’t edit your code for over a year.<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>

<p>After resolving that error I was able to reproduce the crash and see a much more verbose error message. You know how some YouTube videos have embedding disabled? I’m using a library, <a href="https://github.com/judofyr/ruby-oembed">ruby-oembed</a>, to fetch embed codes from video URLs, and it raises an exception when the video has embedding disabled. I used to think that meant my thing needed to crash but I’ve since learned about exception handling. Here’s a before:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_embed</span> <span class="p">(</span><span class="n">vid_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">vid_site</span> <span class="o">==</span> <span class="ss">:youtube</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://www.youtube.com/watch?v=</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Youtube</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="nf">html</span>
  <span class="k">elsif</span> <span class="n">vid_site</span> <span class="o">==</span> <span class="ss">:vimeo</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://www.vimeo.com/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Vimeo</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="ss">maxwidth: </span><span class="s2">"500"</span><span class="p">,</span> <span class="ss">portrait: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">byline: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">title: </span><span class="kp">false</span><span class="p">).</span><span class="nf">html</span>
  <span class="k">elsif</span> <span class="n">vid_site</span> <span class="o">==</span> <span class="ss">:hulu</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://www.hulu.com/watch/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Hulu</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="nf">html</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="s2">"&lt;p&gt;Failed to get embed code&lt;/p&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>And after:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_embed</span> <span class="p">(</span><span class="n">vid_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">case</span> <span class="n">vid_site</span>
    <span class="k">when</span> <span class="ss">:youtube</span>
      <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Youtube</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"http://www.youtube.com/watch?v=</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">).</span><span class="nf">html</span>
    <span class="k">when</span> <span class="ss">:vimeo</span>
      <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Vimeo</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"http://www.vimeo.com/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">maxwidth: </span><span class="s2">"500"</span><span class="p">,</span> <span class="ss">portrait: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">byline: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">title: </span><span class="kp">false</span><span class="p">).</span><span class="nf">html</span>
    <span class="k">when</span> <span class="ss">:hulu</span>
      <span class="no">OEmbed</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">Hulu</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"http://www.hulu.com/watch/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">).</span><span class="nf">html</span>
    <span class="k">else</span>
      <span class="s2">"Unsupported site"</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">inspect</span>
    <span class="s2">"&lt;p&gt;Sorry, couldn't get the embed code for this one. Maybe it doesn't allow embedding? Or maybe it was deleted? Sorry.&lt;/p&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>(I guess I didn’t know about case statements or implicit return values then either.)</p>

<p>It’s still not that great honestly. I wish it were more object oriented. I wish there were tests. I wish I could open source it without exposing my Instapaper API keys. I know it’s possible to scrub your history and I’m going to look into that, and then keep them in a separate file ignored by git; or maybe I’ll look into getting new keys. But I’m glad to be revisiting this project because it’s where I got excited about web development. One last before and after:</p>

<p>Layabout needs to ignore bookmarks that it doesn’t know how to embed. It also needs clean URLs to reliably lookup their embed codes. Here’s an old method which helped with this task:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">grok_url</span> <span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="c1"># TODO support hulu short urls</span>
  <span class="k">if</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/youtube\.com\/embed\//</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/\/embed\/([A-Za-z0-9_-]+)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:youtube</span>
  <span class="k">elsif</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/youtube\.com/</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/v=([A-Za-z0-9_-]+)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:youtube</span>
  <span class="k">elsif</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/youtu\.be/</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/(http:\/\/youtu.be\/)([A-Za-z0-9\-_]+)/</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:youtube</span>
  <span class="k">elsif</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/vimeo\.com\/m\//</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/\/m\/(\d+)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:vimeo</span>
  <span class="k">elsif</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/vimeo\.com/</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/vimeo\.com\/([\d]+)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:vimeo</span>
  <span class="k">elsif</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/hulu\.com\/watch/</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/watch\/([\d]+)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="n">site</span> <span class="o">=</span> <span class="ss">:hulu</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="kp">true</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="nb">id</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I used it like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">video_links</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span>
<span class="k">if</span> <span class="n">folder_id</span> <span class="o">==</span> <span class="ss">:readlater</span>
  <span class="n">all_links</span> <span class="o">=</span> <span class="n">ip</span><span class="p">.</span><span class="nf">bookmarks_list</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">all_links</span> <span class="o">=</span> <span class="n">ip</span><span class="p">.</span><span class="nf">bookmarks_list</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:folder_id</span> <span class="o">=&gt;</span> <span class="n">folder_id</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">all_links</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"bookmark"</span> <span class="c1"># filters out the first two irrelevant items</span>
    <span class="n">is_video</span><span class="p">,</span> <span class="n">vid_site</span><span class="p">,</span> <span class="n">video_id</span> <span class="o">=</span> <span class="n">grok_url</span> <span class="n">link</span><span class="p">[</span><span class="s2">"url"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_video</span> <span class="o">==</span> <span class="kp">true</span>
      <span class="n">link</span><span class="p">[</span><span class="s2">"video_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_id</span>
      <span class="n">link</span><span class="p">[</span><span class="s2">"title"</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanup_title</span> <span class="n">link</span><span class="p">[</span><span class="s2">"title"</span><span class="p">]</span> <span class="c1"># prob not necessary</span>
      <span class="n">link</span><span class="p">[</span><span class="s2">"vid_site"</span><span class="p">]</span> <span class="o">=</span> <span class="n">vid_site</span>
      <span class="n">link</span><span class="p">[</span><span class="s2">"description"</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_clicky</span> <span class="n">link</span><span class="p">[</span><span class="s2">"description"</span><span class="p">]</span>
      <span class="n">video_links</span><span class="p">.</span><span class="nf">push</span> <span class="n">link</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="vi">@videos</span> <span class="o">=</span> <span class="n">video_links</span>
</code></pre>
</div>

<p>Honestly I think this is cool code even though it’s not how I’d write it now, because this is what it looks like to make it work with limited knowledge. I didn’t know about any fancy iterators. I legit didn’t know about object oriented programming. I didn’t know it’s not necessary to check if a boolean <code class="highlighter-rouge">== true</code>, but it wasn’t hurting anyone! Whenever I’m talking to beginners and see code that doesn’t take advantage of less-than-obvious techniques, but works, I’m psyched.</p>

<p>Anyway this is what I changed it to yesterday:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="vi">@videos</span> <span class="o">=</span> <span class="p">(</span><span class="k">if</span> <span class="n">folder_id</span> <span class="o">==</span> <span class="ss">:readlater</span>
  <span class="n">ip</span><span class="p">.</span><span class="nf">bookmarks_list</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">ip</span><span class="p">.</span><span class="nf">bookmarks_list</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:folder_id</span> <span class="o">=&gt;</span> <span class="n">folder_id</span><span class="p">)</span>
<span class="k">end</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'bookmark'</span> <span class="c1"># filters out the first two irrelevant items</span>
    <span class="n">snob</span> <span class="o">=</span> <span class="no">FilmSnob</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">'url'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">snob</span><span class="p">.</span><span class="nf">watchable?</span>
      <span class="n">link</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
        <span class="n">link</span><span class="p">[</span><span class="s1">'video_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">snob</span><span class="p">.</span><span class="nf">id</span>
        <span class="n">link</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanup_title</span> <span class="n">link</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
        <span class="n">link</span><span class="p">[</span><span class="s1">'vid_site'</span><span class="p">]</span> <span class="o">=</span> <span class="n">snob</span><span class="p">.</span><span class="nf">site</span>
        <span class="n">link</span><span class="p">[</span><span class="s1">'description'</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_clicky</span> <span class="n">link</span><span class="p">[</span><span class="s1">'description'</span><span class="p">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">.</span><span class="nf">compact</span>
</code></pre>
</div>

<p>I don’t even necessarily think that’s better, but it satisfies my learned allergy to local variables<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup> and makes me feel cool for using <code class="highlighter-rouge">map</code> and <code class="highlighter-rouge">tap</code>.</p>

<p>Ah, and what’s <code class="highlighter-rouge">FilmSnob</code>? Let’s revisit Resig’s blog post:</p>

<blockquote>
  <p>I decided to set a couple rules for myself:</p>

  <ol>
    <li>I must write code every day. I can write docs, or blog posts, or other things but it must be in addition to the code that I write.</li>
    <li>It must be useful code. No tweaking indentation, no code re-formatting, and if at all possible no refactoring. (All these things are permitted, but not as the exclusive work of the day.)</li>
    <li>All code must be written before midnight.</li>
    <li>The code must be Open Source and up on Github.</li>
  </ol>
</blockquote>

<p>Because Layabout isn’t currently open-sourceable, I extracted part of it into <a href="https://github.com/maxjacobson/film_snob">a rubygem called film_snob</a>. It’s basically just that <code class="highlighter-rouge">grok_url</code> method, but made object-oriented, tested, and designed to be more extensible in case I ever want to support more than three video sites. <a href="https://github.com/maxjacobson/film_snob/issues/1">I hope</a> to also extract the embedcode fetching from Layabout into film_snob, but without the ruby-oembed dependency.</p>

<hr />

<p><strong>update</strong> I did implement the oembed stuff!! Yeah!!</p>
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>By giving my Instapaper credentials directly to the app, which I now know is kind of a no-no in the age of Oauth (though I’ve given my Instapaper credentials directly to some other apps like <a href="http://reederapp.com/">Reeder</a> and <a href="http://tapbots.com/software/tweetbot/">Tweetbot</a> so idk. Definitely a smell. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Which was totally possible because all of the API keys were hardcoded into the app. Smell! <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>What’s weird to me is that the version number seems to have regressed? The assumption that views are in a folder called views was introduced in 1.1, and I seem to have been taking advantage of that, but then it forgets to assume that? I don’t know. Versions are hard. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>except the <code class="highlighter-rouge">snob</code> variable which I’m not sure how to avoid; suggestions welcome!! <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="post-footer">
    <p>
      Feel free to get in touch via <a href='http://twitter.com/maxjacobson'>@maxjacobson</a> or <a href='mailto:max@hardscrabble.net'>max@hardscrabble.net</a>
    </p>
  </div>

</div>


<footer>
  <div>
    Powered by <a href="http://jekyllrb.com/">Jekyll</a>
    and hosted on <a href="https://pages.github.com/">GitHub Pages</a>.
    The source is <a href="https://github.com/hardscrabble/hardscrabble.github.io">available to browse, for nerds</a>.
    The feed can be found at <a href="/feed.xml">feed.xml</a>
  </div>
</footer>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src='/js/vendor/lunr.min.js'></script>
<script src='/js/app.js'></script>


<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100815498); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100815498ns.gif" /></p></noscript>
</body>
</html>

